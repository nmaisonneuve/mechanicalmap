<!DOCTYPE html>
<html lang="en">
<head>

    <title>Name Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="authenticity_token" name="csrf-param"/>
    <meta content="JHQhNFmZOx+cHGlXcnFEAaQnbmy7kH0A+sY1sr2sx4Y=" name="csrf-token"/>
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->

    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
    <link href="http://twitter.github.com/bootstrap/assets/css/bootstrap-responsive.css" rel="stylesheet">


</head>
<script type="text/javascript">
    var user = {name:"nico"};
    var scheduler_url = "http://localhost:3000/apps/1/workflow";
    var application_url = "http://localhost:3000/apps/1";
    var ft_table = "1MOMA4acYJqoPbDIxDjvysjGrcncvYngwSySHfPI";
</script>

<body>
<div class="container">
    <div class="row">
        <div class="span12">
            <img width="250"
                 src="http://www.ipp.csic.es/sites/default/files/imagecache/imagenes_proyectos_ipp/IPP/proyectos/imagen/Academic%20%20inventors%20logo.png"
                 style="float:left;margin:10px">

            <h1>Name Game
                <small><br/>Help us link spanish documents to the right person</small>
            </h1>
<!--
            <p> The machine believes theses <b>spanish academic papers or patents</b> belongs to <b>the same person</b>
                called
                "Person 1". It judges according to the author name and his/her affiliation written on each document.
            </p>-->

        <!--    <p>
                <b>The game </b> is to review this list and cluster the documents into a set of distinct persons if
                you
                detect errors.
            </p>-->
            <p>
                <b>The game </b> is to cluster these list of academic papers or patents into a set of distinct persons.
                 By default, all these documents belong to the same person called "Person 1".
            </p>
            <p>
                <b>How to do:</b> if you detect that several documents belong to a different person than other ones,
                <b>change</b> their value of the column <i>"belongs to"</i> with "Person 2"
                , or "person 3" if you detect a third distinct person in the list, etc.

            </p>

            <p>
                <span class="label label-warning">warning</span> It could be sometime tricky. <a href="#">See some
                common errors and practices to solve them</a>.

            </p>

        </div>
    </div>

    <div class="row">
        <div class="span12">
            <div style="float:right">

               <b>user</b>: <span id="task_user_id"></span>
                <span style="float:left;margin-right: 5px"><b>completeness</b> </span>

                <div class="progress" style="width:100px;">
                    <div class="bar" id="progress_bar"
                         style="width: 10%;color:black;font-size: smaller;padding: 0;margin: 0"></div>
                </div>
            </div>
            <h3>List of documents </h3>


            <div id='table_div'></div>

        </div>
    </div>

    <div class='row'>
        <div class="span12" style="text-align: center; margin-top: 10px">
            <form accept-charset="UTF-8" action="" id="form_task" class="edit_task"
                  data-remote="true" data-type="json" id="submit_task" method="put">
                <input id="task_answer" name="task_answer" type="hidden"/>

                <button type="button" id='submit_button' class="btn btn-primary" data-disable-with="Saving..."
                        name="relevant">
                    Submit
                </button>
                <a id='skip_task' class="btn btn-small" href="#" style="margin-left: 10px">Skip</a>
            </form>

        </div>


    </div>


    <!-- javascript
   ================================================== -->
    <script type='text/javascript' src='https://www.google.com/jsapi'></script>
    <script src="http://localhost:3000/assets/application.js" type="text/javascript"></script>

    <script src='inheritance.js'></script>
    <script src='model.js'></script>
    <script src='http://borismoore.github.com/jsrender/jsrender.js'></script>
    <script src='stopwords.js'></script>
    <script src='http://twitter.github.com/bootstrap/assets/js/bootstrap-collapse.js'></script>
    <script src='http://twitter.github.com/bootstrap/assets/js/bootstrap-tooltip.js'></script>
    <script src='http://twitter.github.com/bootstrap/assets/js/bootstrap-popover.js'></script>


    <script type="text/javascript">
        // Global variables

        var micro_task;
        var ft_table_document = "3950961";
        var documents = [];
        var table_data;
        var table;

        function generate_selection(nb, selected_id, row_id) {
            var select = "<select onchange='select_person(this);'>";
            select += "<option checked='true' value='" + selected_id + "' data-rowid='" + row_id + "'>Person " + selected_id + "</option>"
            for (var i = 1; i <= nb; i++) {
                if (i != selected_id) {
                    select += "<option value='" + i + "' data-rowid='" + row_id + "'>Person " + i + "</option>";
                }
            }
            select += "</select>";
            return select;
        }

        function lookup_documents(clusterID) {
            var query = "SELECT PersonID, FName,LName, Affiliation,DocumentType,DocumentTitle,ApplicantName FROM " + ft_table_document + " WHERE ClusterID='" + clusterID + "'";
            //this.loading();

            micro_task.ft_request(query, function (ft_data) {
                console.log("number of rows: "+table_data.getNumberOfRows());
                // building table
                var nb = ft_data.table.rows.length;
                var data = [];
                $.each(ft_data.table.rows, function (i, row) {
                    documents.push({rowid:row[0],personID:1,clusterID:clusterID});

                    var name =row[1].toLowerCase() + ", " + row[2].toLowerCase();
                    var affiliation=row[3]+((row[4]=="APPLICATION") ? row[6] :"");
                    var title=row[5].toLowerCase();
                    var moreinfo="<a href='http://scholar.google.com/scholar?hl=en&q="+encodeURIComponent(row[5])+"' target='_blank'><b>get more info</b></a>" ;
                    data.push([name,affiliation, title , moreinfo,generate_selection(nb, 1, i)]);
                });
                table_data.addRows(data);
                table.draw(table_data, {showRowNumber:true, allowHtml:true, sortColumn:0});
               // $('.google-visualization-table-th:contains(Author Name)').css('width', "100px");
                $('.google-visualization-table-th:contains(Belongs to)').css('width', "70px");
                google.visualization.events.addListener(table, 'ready', function(){
                  //  $('.google-visualization-table-th:contains(Doc title)').css('width', "50px");
                    console.log("test ok ok");

                });

            });
        }
        function select_person(select) {
            var val = $(select).find("option:selected").val();
            var row_id = $(select).find("option:selected").data("rowid");
            table_data.setCell(row_id, 2, generate_selection(table_data.getNumberOfRows(), val, row_id));
            documents[row_id-1]["personID"]=val;
        }


        function resize_image() {
            // calculate new size and apply it
            var max_h = $(window).height();
            var max_w = $(window).width();
            var m_h = $("#menu").height();
            //$("#info").height(max_h - m_h);
        }

        google.load('visualization', '1', {packages:['table']});
        google.setOnLoadCallback(function () {
            $(function () {

                table_data = new google.visualization.DataTable();
                table_data.addColumn('string', 'Author Name');
                table_data.addColumn('string', 'Author Affiliation');
                table_data.addColumn('string', 'Doc title');
                table_data.addColumn('string', 'Need more info?');
                table_data.addColumn('string', 'Belongs to');

                table = new google.visualization.Table(document.getElementById('table_div'));


                // initializing the UI
                $("#submit_button").click(function () {
                    $("#form_task").submit();
                });

                // initializing the task manager
                // we have to manage the loading and saving of a task
                micro_task = new FTMicroTask({
                    scheduler_url:scheduler_url,
                    ft_table:ft_table,

                    debug_request_task:function (from_task) {

                        lookup_documents("1");
                    },

                    loading:function () {
                        console.log("loading task..");

                    },
                    load:function (ft_data) {
                        console.log(ft_data);
                        documents=[];
                        table_data.removeRows(0, table_data.getNumberOfRows());
                        // parse specific task info
                        var clusterID = ft_data.table.rows[0][2];
                        lookup_documents(clusterID);
                    },
                    save:function () {
                        var rows = [];
                        $.each(documents,function(index, doc){
                           rows.push({clusterID:doc["clusterID"], personID:doc["oersonID"]});
                        });
                        console.log(rows);
                        $("#task_answer").val(JSON.stringify(rows));
                    }
                });
                micro_task.start();
                resize_image();
            });
        });
    </script>


</html>