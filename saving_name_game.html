<!-- BEGINNING OF The UI Task TEMPLATE
================================================== -->
<!-- schema=[{name:"task_id", type:"number"},{name:"user_id", type:"number"},{name:"clusterID", type:"string"},{name:"personID", type:"string"}] -->
<div class="container">
    <div class="row">
        <div class="span12">
            <img width="250"
                 src="http://www.ipp.csic.es/sites/default/files/imagecache/imagenes_proyectos_ipp/IPP/proyectos/imagen/Academic%20%20inventors%20logo.png"
                 style="float:left;padding:20px">


            <h1>Name Game
                <small><br/>Help us link spanish documents to the right person</small>
            </h1>
            <!--
            <p> The machine believes theses <b>spanish academic papers or patents</b> belongs to <b>the same person</b>
                called
                "Person 1". It judges according to the author name and his/her affiliation written on each document.
            </p>-->

            <!--    <p>
                <b>The game </b>  is to review this list and cluster the documents into a set of distinct persons if
                you
                detect errors.
            </p>-->
            <p>
                <b>The game </b> is to cluster these list of academic papers or patents into a set of distinct persons.
                By default, all these documents belong to the same person called "Person 1".
            </p>
            <p>
                <b>How to do:</b>
            <ul>
                <li><b>sort</b> the table by name or by affiliation of the author to detect different persons.</li>
                <li>if you have a doubt on a document, clik on "get more info" to search on internet</li>
                <li>if you detect documents belonging to a different person than other ones,
                    <b>change</b> the column <i>"belongs to"</i> to "Person 2"
                    , or "person 3" if you detect a third distinct person in the list, etc.
                </li></ul>
            </p>

            <p>
                <span class="label label-warning">warning</span> It could be sometime tricky. <a href="#">See some
                common errors and practices to solve them</a>.

            </p>

        </div>
    </div>

    <div class="row">
        <div class="span12">
            <div style="float:right">


                <span style="float:left;margin-right: 5px"><b>completeness</b> </span>
                <span id="task_done"> </span> tasks completed
                <div class="progress" style="width:100px;">
                    <div class="bar" id="progress_bar"
                         style="width: 10%;color:black;font-size: smaller;padding: 0;margin: 0"></div>
                </div>
            </div>
            <h3>List of documents </h3>


            <div id='table_div'></div>

        </div>
    </div>

    <div class='row'>

        <div class="span12" style="text-align: center; margin-top: 10px">
            <div style="float:right"> <b>User</b>: <span id="task_user_id"></span></div>
            <form accept-charset="UTF-8" action="" id="form_task" class="edit_task"
                  data-remote="true" data-type="json" id="submit_task" method="put">
                <input id="task_answer" name="task_answer" type="hidden"/>

                <button type="button" id='submit_button' class="btn btn-primary" data-disable-with="Saving..."
                        name="relevant">
                    Submit
                </button>
                <a id='skip_task' class="btn btn-small" href="#" style="margin-left: 10px">Skip</a>
            </form>

        </div>


    </div>

</div>
<!-- javascript
================================================== -->
<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type="text/javascript">
    // Global variables

    var micro_task;
    var documents = [];
    var table_data;
    var table;


    var NameGame = FTMicroTask.extend({

        init:function (options) {
            this.documents = [];
            this._super(options);
        },

        reset:function () {
            this.ocuments = [];
            table_data.removeRows(0, table_data.getNumberOfRows());
        },

        request_task:function (from_task, callback) {
            var me = this;
            this.loading();
            var ft_table_document = "3950961";
            //default value
            if (callback == null) {
                callback = me.load
            }

            this._super(from_task, function (task) {
                console.log(task);

                // parse specific task info
                var clusterID = task.data.table.rows[0][2];
                var query = "SELECT PersonID, FName,LName, Affiliation,DocumentType,DocumentTitle,ApplicantName FROM " + ft_table_document + " WHERE ClusterID='" + clusterID + "'";
                me.ft_request(query, function (ft_data) {
                    task.data = ft_data;
                    callback(task);
                });
            });
        },

        load:function (task) {
            this._load(task);
            this.reset();


            // building table
            var nb = task.data.table.rows.length;
            var data = [];

            $.each(task.data.table.rows, function (i, row) {
                documents.push({rowid:row[0], personID:1, clusterID:clusterID});
                var name = row[1].toLowerCase() + ", " + row[2].toLowerCase();
                var affiliation = row[3] + ((row[4] == "APPLICATION") ? row[6] : "");
                var title = row[5].toLowerCase() + "<a href='http://scholar.google.com/scholar?hl=en&q=" + encodeURIComponent(row[5]) + "' target='_blank'><b>get more info</b></a>"
                data.push([name, affiliation, title , generate_selection(nb, 1, i)]);
            });

            table_data.addRows(data);
            table.draw(table_data, {showRowNumber:true, allowHtml:true, sortColumn:0});
            $('.google-visualization-table-th:contains(Author Name)').css('width', "20%");
            $('.google-visualization-table-th:contains(Author affiliation)').css('width', "35%");
            $('.google-visualization-table-th:contains(Doc title)').css('width', "35%");
            $('.google-visualization-table-th:contains(Belongs to)').css('width', "110px");
        },
        save:function () {
            var rows = [];
            $.each(documents,function(index, doc){
                rows.push({clusterID:doc["clusterID"], personID:doc["personID"]});
            });

            $("#task_answer").val(JSON.stringify(rows));
        }

    });

    function generate_selection(nb, selected_id, row_id) {
        var select = "<select style='width:100px' onchange='select_person(this);'>";
        select += "<option checked='true' value='" + selected_id + "' data-rowid='" + row_id + "'>Person " + selected_id + "</option>"
        for (var i = 1; i <= nb; i++) {
            if (i != selected_id) {
                select += "<option value='" + i + "' data-rowid='" + row_id + "'>Person " + i + "</option>";
            }
        }
        select += "</select>";
        return select;
    }

    function select_person(select) {
        var val = $(select).find("option:selected").val();
        var row_id = $(select).find("option:selected").data("rowid");
        table_data.setCell(row_id, 3, generate_selection(table_data.getNumberOfRows(), val, row_id));
        documents[row_id-1]["personID"]=val;
    }

   google.load('visualization', '1', {packages:['table']});
    google.setOnLoadCallback(function () {
        $(function () {

            table_data = new google.visualization.DataTable();
            table_data.addColumn('string', 'Author Name');
            table_data.addColumn('string', 'Author affiliation (address)');
            table_data.addColumn('string', 'Doc title');
            table_data.addColumn('string', 'Belongs to');
            table = new google.visualization.Table(document.getElementById('table_div'));

            // initializing the UI
            $("#submit_button").click(function () {
                $("#form_task").submit();
            });

            // initializing the task manager
            // we have to manage the loading and saving of a task
            micro_task = new NameGameTask({
                scheduler_url:scheduler_url,
                ft_table:ft_table});
            micro_task.start();

        });
    });
</script>