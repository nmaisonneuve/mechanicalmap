<link href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" rel="stylesheet">
<link href="/assets/base_app.css" rel="stylesheet">
<style>
  #map img {
    max-width: none;
  }
</style>

<!-- section tag = view for a state of the app -->
<section id="intro">
  <img src="http://cache.gawkerassets.com/assets/images/4/2011/11/xlarge_b571ffd4051b3e8205dd3175f2bb2eed.jpg"
       width="100%">

  <div class="headline">
    <h3>Help us identify strange buildings in maps</h3>

    <div style="text-align:center;width:100%">
      <a id="start" class="btn btn-primary btn-large" href="#static/instructions">Start</a>
    </div>
  </div>
</section>

<!-- intructions -->
<section id="instructions" class="span6">
  <h3>Mission: Identify strange structures around China</h3>
  Recently Unidentified titanic structures have been <a target="_blank"
                                                        href="http://www.gizmodo.com.au/2011/11/why-is-china-building-gigantic-structures-in-the-middle-of-the-desert/">discovered </a>
  in the middle of the Chinese desert.
  <ul class="thumbnails">
    <li class="span3"><img
        src="http://cache.gawkerassets.com/assets/images/4/2011/11/135710bd6334230b993524c8f1a02876.png"
        height="150px"/></li>
    <li class="span3"><img
        src="http://cache.gawkerassets.com/assets/images/4/2011/11/d74e9bfdf3d720f578419966b0eb4ca9.png"
        height="150px"/></li>
  </ul>
  <h3>Level 1: analyze the first 10 area</h3>

  <p>you will display a serie of areas delimited by a red box, report potential strange structures inside by click on
    them on the map, or go to the next area else </p>

  <div style="text-align: center">
    <a href="#play" class="btn btn-primary btn-large">Next</a>
  </div>
</section>

<!-- end of the experience -->
<section id="about">
  <div class="modal-body">
    <h3>Beyond direct contribution</h3>
    <ul>
      <li><b>Spread the app</b>: Help us by embedding this app to your web site so your visitors can contribute.
        <br/>
        <textarea class="span7">&lt;iframe width="700px" height="400px" scrolling="no"
          src="http://mechanicaltask.dev.fabelier.org/apps/6?embeddable=1"&gt;&lt;/iframe&gt;</textarea>
      </li>
      <li><b>Improve the app</b> by <a href="https://gist.github.com/3028859" style="margin:5px">improving the source
        code</a> and cloning the app
      </li>
      <li><b>Analyse</b> the <a
          href="http://www.google.com/fusiontables/DataSource?docid=12i8cwFjiCpazX9dGuH7wqet1kc_1Q1GP6TRkGOI"
          target="_blank">Answer Data</a>
        and the <a target="_blank"
                   href="http://www.google.com/fusiontables/DataSource?docid=1pSWNLzQE0oZSs7KJqzhjsMeT96QELkmE9gROt7E"
                   target="_blank">task data</a>

      </li>


    </ul>
    <h3>About</h3>

    <p>This app has been generated by the <a href="http://mechanicaltask.dev.fabelier.org/">VolatileTask toolkit</a>.
    </p>

    <p> The large area has been automatically generated using the <a
        href="http://mechanicaltask.dev.fabelier.org/demo_generator">GIS Task Generator </a>. Try it yourself!</p>
  </div>
  </div>
</section>

<!--  task -->
<section id="task">
  <div id="loading" style="position:absolute;top:0;right:0;padding:5px;z-index:10;background:#A00;color:white">
    Loading...
  </div>
  <div id="map" style="height: 300px"></div>
  <div id="menu" style="margin: 0;padding: 0;clear: both">
    <div class="navbar" style="margin: 0;padding: 0">
      <div class="navbar-inner">
        <div class="container">

          <button id="save" class="btn btn-primary">Submit + next Area</button>
          <!--  <a id='skip_task' href="#play" class="btn">Skip area</a>     -->
          <ul class="nav">
            <li class="">
              <a href="#" id="task_user_id"></a>
            </li>
            <li class="navbar-search">
              <div class="progress navbar-search" style="width:50px;height: 10px">
                <div class="bar" id="progress_bar"
                     style="width: 10%;color:black;font-size: smaller;padding: 0;margin: 0"></div>
              </div>
            </li>
            <li class="divider-vertical"></li>
          </ul>
          <a href="#static/instructions" id="about_button" class="btn">Instructions</a>
          <a href="#static/about" id="about_button" class="btn">About</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- javascript
================================================== -->
<script src="/assets/base_app_router.js"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&libraries=drawing"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-modal.js"></script>
<script src="/assets/geo_json.js"></script>
<script src="/assets/map_helper.js"></script>

<script type="text/javascript">
  // Global variables
  var G = google.maps;
  var map;
  var map_manager = {

    initialize:function () {
      /** MAP **/
      map = new G.Map(document.getElementById("map"), {
        zoom:3,
        center:new G.LatLng(70, 0),
        mapTypeId:G.MapTypeId.SATELLITE,
        panControl:false,
        zoomControl:true,
        scaleControl:false,
        streetViewControl:false,
        overviewMapControl:false
      });

      /** drawing manager **/
      var drawingManager = new G.drawing.DrawingManager({
        drawingMode:G.drawing.OverlayType.MARKER,
        drawingControl:true,
        drawingControlOptions:{
          position:G.ControlPosition.TOP_CENTER,
          drawingModes:[G.drawing.OverlayType.MARKER]
        },
        markerOptions:{
          zIndex:1,
          draggable:true
        }
      });

      drawingManager.setMap(map);
      G.event.addListener(drawingManager, 'markercomplete', function (marker) {
        // outside the area
        if (!area.getBounds().contains(marker.position)) {
          marker.setMap(null);
        } else {
          // we remove the marker if we click on it
          G.event.addListener(marker, 'click', function () {
            markers = jQuery.grep(markers, function (value) {
              return value != marker;
            });
            marker.setMap(null);
          });
          markers.push(marker);
        }
      });

      $(window).resize(this.resize_widget);
    },

    //dynamically resize the map
    resize_widget:function () {
      // calculate new size and apply it
      var max_h = $(window).height();
      var max_w = $(window).width();
      var m_h = $("#menu").height();
      if (this.map != null) {
        $("#map").height(max_h - m_h);
        G.event.trigger(this.map, "resize");
      }
    },

    clean:function () {
      // cleaning map
      for (var i = 0; i < this.markers.length; i++) {
        this.markers[i].setMap(null);
      }
      this.markers.length = 0;
      if (area != null)
        area.setMap(null);
    },

    create_area:function (poly_js) {
      this.clean();
      area = new GeoJSON(poly_js);
      area.setOptions({
        strokeColor:"#FF0000",
        strokeWeight:"2",
        fillOpacity:0
      });
      area.setMap(map);
      // center the map to the polygon
      map.fitBounds(area.getBounds());
    }
  }


  $(function () {

    /**
     * we configure the router of the app
     */
    app.add_route("play", function () {
      this.static_content("task");
      resize_widget();
      app.tasks.next();
    });

    app.add_route("tasks/:id", function (id) {
      task = app.tasks.get(id);
      $("#save").click(function() {
        $("#save").unbind();
        var rows = [];
        // no annotation
        if (markers.length == 0)
          rows.push({annotation:" "});
        else {
          for (var i = 0; i < markers.length; i++) {
            rows.push({
              annotation:markers[i].position.lat() + " " + markers[i].position.lng()
            });
          }
        }
        task.save_answer(rows);
      });

      // parse info to create a google map polygon
      var poly_js = task.get('area').geometry;
      map_manager.create_area(poly_js);
    });

    app.add_route("tasks/:id/answered", function (id) {
      var pourcentage;
      $(".bar").width(pourcentage + "%");
      app.navigate("play");
    });


    /**
     *  We generate a volatile app
     *
     */
    var app = new VolatileTaskApp({root_url:application_url});

    // we register a set of events fired by the task manager
    app.tasks.on('loading_task', function () {
      $("#loading").show();
    });

    app.tasks.on('next_task', function (task) {
      app.navigate("tasks/" + task.id);
    });

    app.tasks.on('no_task', function () {
      app.navigate("static/thanks");
    });

    app.start("static/intro");


  });
</script>