<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">
    // Global variables
    var map;
    var marker1;
    var marker2;
    var rectangle;

    /**
     * Called on the initial page load.
     */
    function init() {

        $("#clean").click(function() {
            if (marker1 != null) {
                marker1.setMap(null);
                marker1 = null;
            }
            if (marker2 != null) {
                marker2.setMap(null);
                marker2 = null;

                rectangle.setMap(null);
                rectangle = null;
            }

        });

        map = new google.maps.Map(document.getElementById('map'), {
            'zoom': 3,
            'center': new google.maps.LatLng(70, 0),
            'mapTypeId': google.maps.MapTypeId.SATELLITE
        });

        google.maps.event.addListener(map, 'click', function(event) {

            if (marker1 == null) {
                marker1 = new google.maps.Marker({
                    map: map,
                    position: event.latLng,
                    draggable: true,
                    title: 'Drag me!'
                });
                map.setCenter(event.latLng);

            } else

            if (marker2 == null) {
                marker2 = new google.maps.Marker({
                    map: map,
                    position: event.latLng,
                    draggable: true,
                    title: 'Drag me!'
                });

	rectangle= new google.maps.Rectangle({map:map});
                redraw();   
         
                google.maps.event.addListener(marker1, 'dragend', redraw);
                google.maps.event.addListener(marker2, 'dragend', redraw);

	}
        });


    }

    /**
     * Updates the Rectangle's bounds to resize its dimensions.
     */
    function redraw() {
        var latLngBounds = new google.maps.LatLngBounds(
                marker1.getPosition(),
                marker2.getPosition()
        );
//	console.log("ok");
        rectangle.setBounds(latLngBounds);

        $("#project_lat_ne").val(latLngBounds.getNorthEast().lat());
        $("#project_lng_ne").val(latLngBounds.getNorthEast().lng());
        $("#project_lat_sw").val(latLngBounds.getSouthWest().lat());
        $("#project_lng_sw").val(latLngBounds.getSouthWest().lng());


    }

    // Register an event listener to fire when the page finishes loading.
    $(function() {
        init();
    });
</script>

<div class="container">
  <div class="row">
    <div class="span3">
<h1>New project</h1>
      <%= form_for(@project) do |f| %>
          <%= f.hidden_field :lat_sw %>
          <%= f.hidden_field :lng_sw %>
          <%= f.hidden_field :lat_ne %>
          <%= f.hidden_field :lng_ne %>

          <% if @project.errors.any? %>
              <div id="error_explanation">
                <h2><%= pluralize(@project.errors.count, "error") %> prohibited this project from being saved:</h2>
                <ul>
                  <% @project.errors.full_messages.each do |msg| %>
                      <li><%= msg %></li>
                  <% end %>
                </ul>
              </div>
          <% end %>


          <div class="field">
            Name of the project
            <br/>
            <%= f.text_field :name %>
          </div>
 <div class="field">
           Add your own map WMS URL (optional)
            <br/>
            <%= f.text_field :wms %>
          </div>
          <div class="field">
            Instructions displayed for the volunteers.
            <br/>(Wiki style , see <a href="http://redcloth.org/hobix.com/textile/">wiki format</a>)
            <br/>
            <%= f.text_area :description, :size => "50x5" %>
          </div>
	<button class="btn btn-primary">Submit</button>
      <% end %>
      </div>

      <div class="span8">
          Click on the map to define the area to divide (<button id='clean'>clean area</button>)
            <div id="map"></div>
	</div>
    </div>
</div>
