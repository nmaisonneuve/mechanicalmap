<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

<script type="text/javascript">
    // Global variables
    var map;
    var marker1;
    var marker2;
    var rectangle;
var G=google.maps;
    /**
     * Called on the initial page load.
     */
    function init() {

        $("#clean").click(function() {
            if (marker1 != null) {
                marker1.setMap(null);
                marker1 = null;
            }
            if (marker2 != null) {
                marker2.setMap(null);
                marker2 = null;

                rectangle.setMap(null);
                rectangle = null;
            }
        });

        map = new google.maps.Map(document.getElementById('map'), {
            'zoom': 3,
            'center': new google.maps.LatLng(70, 0),
            'mapTypeId': google.maps.MapTypeId.SATELLITE
        });

        google.maps.event.addListener(map, 'click', function(event) {

            if (marker1==null || marker2 != null) {
				marker1= new google.maps.LatLng(event.latLng.lat(),event.latLng.lng());
                map.setCenter(marker1);
				marker2=null;
            } else	{
				marker2= new google.maps.LatLng(event.latLng.lat(),event.latLng.lng());
				create_area(marker1.lat(),marker1.lng(),marker2.lat(),marker2.lng());
			}
        });

    }

function create_grid(lat_sw, lng_sw, lat_ne, lng_ne){
	var    div_lat=5.0;
	var    div_lng=5.0;

	var  lat_unit=(lat_ne-lat_sw)/div_lat;
	var  lng_unit =(lng_ne-lng_sw)/div_lng;

	for (var i=0; i<div_lat; i++){
		for (var j=0; j<div_lng; j++){
			var cell_lat_sw=lat_sw+lat_unit*i;
			var cell_lng_sw=lng_sw+lng_unit*j;
			var        cell_lat_ne=cell_lat_sw+lat_unit;
			var        cell_lng_ne=cell_lng_sw+lng_unit;
			create_area(cell_lat_sw, cell_lng_sw, cell_lat_ne, cell_lng_ne);
		}

	}
}

 function create_area(lat_sw, lng_sw, lat_ne, lng_ne) {

   var bounds = new google.maps.LatLngBounds(
                new G.LatLng(lat_sw, lng_sw),
                new G.LatLng(lat_ne, lng_ne));

        var rectangle = new google.maps.Rectangle({
            map: map,
            bounds: bounds,            
            strokeColor:"#FF0000"            
        });
	return (rectangle);
}

    /**
     * Updates the Rectangle's bounds to resize its dimensions.
     */
    function redraw() {
        var latLngBounds = new google.maps.LatLngBounds(
                marker1.getPosition(),
                marker2.getPosition()
        );
//	console.log("ok");
        rectangle.setBounds(latLngBounds);

        $("#project_lat_ne").val(latLngBounds.getNorthEast().lat());
        $("#project_lng_ne").val(latLngBounds.getNorthEast().lng());
        $("#project_lat_sw").val(latLngBounds.getSouthWest().lat());
        $("#project_lng_sw").val(latLngBounds.getSouthWest().lng());

    }

    // Register an event listener to fire when the page finishes loading.
    $(function() {
        init();
    });
</script>

<div class="container">
  <div class="row">
    <div class="span3">
<h1>New project</h1>
      <%= form_for(@project) do |f| %>
          <%= f.hidden_field :lat_sw %>
          <%= f.hidden_field :lng_sw %>
          <%= f.hidden_field :lat_ne %>
          <%= f.hidden_field :lng_ne %>

          <% if @project.errors.any? %>
              <div id="error_explanation">
                <h2><%= pluralize(@project.errors.count, "error") %> prohibited this project from being saved:</h2>
                <ul>
                  <% @project.errors.full_messages.each do |msg| %>
                      <li><%= msg %></li>
                  <% end %>
                </ul>
              </div>
          <% end %>


          <div class="field">
            Name of the project
            <br/>
            <%= f.text_field :name %>
          </div>
 <div class="field">
           Add your own map WMS URL (optional)
            <br/>
            <%= f.text_field :wms_map %>
          </div>
          <div class="field">
            Copy & Paste your MicroTask template code
	(for more information <a href="/templates">micro task templates</a> )
            <br/>(Wiki style , see <a href="http://redcloth.org/hobix.com/textile/">wiki format</a>)
            <br/>
            <%= f.text_area :description, :size => "50x5" %>
          </div>
	<button class="btn btn-primary">Submit</button>
      <% end %>
      </div>

      <div class="span8">
          Click on the map to define the area to divide (<button id='clean'>clean area</button>)
            <div id="map"></div>
	</div>
    </div>
</div>
