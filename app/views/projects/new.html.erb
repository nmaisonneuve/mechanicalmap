<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false&libraries=drawing,geometry"></script>

<script type="text/javascript">
    // Global variables
    var map;
    var marker_sw;
    var marker_ne;
    var current_rectangle;
    var G = google.maps;

    function refresh_map() {
            var wms_server=$("#project_wms_map").val();
            add_wms_url(wms_server,"toto");
    }

    /**
     * Called on the initial page load.
     */
    function init() {

        $("#project_lat_res").change(compute_nb_tasks);
        $("#project_lng_res").change(compute_nb_tasks);
        $("#project_redundancy").change(compute_nb_tasks);
        $("#add_wms").click(function() {
           event.preventDefault();
            var wms=$(this).attr("href");
            $("#project_wms_map").val(wms);
            refresh_map();
            map.setCenter(new google.maps.LatLng(40.8, -101.6));
        });

        $("#refresh_map").click(refresh_map);

        $("#clean").click(function() {
            if (marker_sw != null) {
                marker_sw.setMap(null);
                marker_sw = null;
            }
            if (marker_ne != null) {
                marker_ne.setMap(null);
                marker_ne = null;
            }
        });

        map = new google.maps.Map(document.getElementById('map'), {
            'zoom': 13,
            'center': new google.maps.LatLng(48.8588, 2.336),
            'mapTypeId': google.maps.MapTypeId.SATELLITE
        });


        var drawingManager = new G.drawing.DrawingManager({
            drawingMode: G.drawing.OverlayType.RECTANGLE,
            drawingControl: true,
            drawingControlOptions: {
                position: G.ControlPosition.TOP_CENTER,
                drawingModes: [
                    G.drawing.OverlayType.RECTANGLE
                ]
            },
            rectangleOptions: {
                zIndex: 1,
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                fillColor: "#949494",
                fillOpacity: 0.1
            }
        });
        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, 'rectanglecomplete', function(rectangle) {
            if (current_rectangle != null) {
                current_rectangle.setMap(null);
            }

            current_rectangle = rectangle;
            marker_ne = rectangle.getBounds().getNorthEast();
            marker_sw = rectangle.getBounds().getSouthWest();
            $("#project_lat_ne").val(marker_ne.lat());
            $("#project_lng_ne").val(marker_ne.lng());
            $("#project_lat_sw").val(marker_sw.lat());
            $("#project_lng_sw").val(marker_sw.lng());

            enable_task_info();
        });
    }

    function compute_nb_tasks() {
        $("#project_lat_res").val();

        console.log(marker_ne.lat()+","+marker_ne.lng());

        console.log(marker_ne.lat()+","+marker_sw.lng());

        console.log(marker_sw.lat()+","+marker_ne.lng());

        lng_distance=google.maps.geometry.spherical.computeDistanceBetween (marker_ne,new google.maps.LatLng(marker_ne.lat(),marker_sw.lng()));
        lat_distance=google.maps.geometry.spherical.computeDistanceBetween (marker_ne,new google.maps.LatLng(marker_sw.lat(),marker_ne.lng()));

        console.log(lng_distance + "," + lat_distance);

        //resolution in degree
        var nb_lat = Math.ceil(lat_distance/($("#project_lat_res").val()*1000));
        var nb_lng = Math.ceil(lng_distance/($("#project_lng_res").val()*1000));

        console.log(nb_lng + "," + nb_lat);


        var redundancy = Math.round($("#project_redundancy").val());
        var nb_tasks = nb_lat * nb_lng * redundancy;
        console.log(nb_tasks);

        $("#nb_tasks").html(nb_tasks);
    }

    function enable_task_info() {
        $("#task_info").show();
        $("#task_helper").hide();
        compute_nb_tasks();

    }
    function disable_task_info() {
        $("#task_info").hide();
        $("#task_helper").show();
        $("#submit").attr("disabled", "true");
    }

    // Register an event listener to fire when the page finishes loading.
    $(function() {
        init();
    });
</script>

<%= form_for(@project, :html=>{:class=>'form-vertical'}) do |f| %>
    <fieldset>
      <legend><%= controller.action_name.capitalize %> Project</legend>
      <div class="row">
        <% if @project.errors.any? %>
            <div id="error_explanation">
              <h2><%= pluralize(@project.errors.count, "error") %> prohibited this project from being saved:</h2>
              <ul>
                <% @project.errors.full_messages.each do |msg| %>
                    <li><%= msg %></li>
                <% end %>
              </ul>
            </div>
        <% end %>

        <div class="span3">


          <%= f.hidden_field :lat_sw %>
          <%= f.hidden_field :lng_sw %>
          <%= f.hidden_field :lat_ne %>
          <%= f.hidden_field :lng_ne %>

          <div class="control-group">
            <div class="control-label">Name of the project</div>
            <div class="controls"><%= f.text_field :name, :class=>"text-field" %></div>
          </div>

          <div class="control-group">
            <div class="control-label">Add your own map (optional)
            <a id="add_wms" href="http://sampleserver1.arcgisonline.com/arcgis/services/Specialty/ESRI_StatesCitiesRivers_USA/MapServer/WMSServer?REQUEST=GetMap&SERVICE=WMS&VERSION=1.3&BGCOLOR=0xFFFFFF&TRANSPARENT=TRUE&SRS=EPSG:4326&WIDTH=256&HEIGHT=256&Styles=default&FORMAT=image/jpeg&CRS=EPSG:4326&layers=0">example</a></div>
            <div class="controls"><%= f.text_field :wms_map, :class=>"text-field", :placeholder=>"URL of your WMS server" %>
              <br/>
              <button type="button" id="refresh_map" class="btn btn-small">refresh map <i class="icon-refresh"></i></button>
            </div>

          </div>
          <div class="alert alert-info" id='task_helper'>
            Draw a rectangle on the map to define the area to analyze
          </div>

          <div id="task_info" style="display:none">
            <div class="control-group">
              <div class="control-label">Area resolution per task (in Km)</div>
              <%= f.text_field :lat_res, :class=>"input-mini", :size=>"3", :maxlength=>"10", :placeholder=>"in km" %> x
              <%= f.text_field :lng_res, :class=>"input-mini", :size=>"3", :maxlength=>"10", :placeholder=>"in km" %>
            </div>

            <div class="control-group">
              <div class="control-label">Task redundancy</div>
              <div class="controls">
                <%= f.text_field :redundancy, :class=>"span1", :placeholder=>"3" %>
              </div>
            </div>
            <div><i class="icon-warning-sign"></i> Tasks generated:</div>
            <h3 id="nb_tasks" class=""></h3>
          </div>

        </div>

        <div class="span9">
          <div id="map" style="max-width:100%"></div>
        </div>

      </div>
      <div class="row">
        <div class="span12">

          <div class="control-group">
            <div class="control-label">
              Paste <a href="#">your scripting micro-task template code</a>
            </div>
            <div class="controls">
              <%= f.text_area :description, :class=>"span12", :size => "50x5", :placeholder=>"Paste your micro-task template code" %>
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </fieldset>
<% end %>